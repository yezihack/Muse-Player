name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸åˆ›å»º release
  
jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build Windows application
        run: npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/*.zip
          retention-days: 5

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build macOS application
        run: npm run dist:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            dist/*.dmg
            dist/*.zip
          retention-days: 5

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build Linux application
        run: npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.tar.gz
          retention-days: 5

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: artifacts/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: artifacts/macos

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: artifacts/linux

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Muse Player v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸµ Muse Player v${{ steps.get_version.outputs.VERSION }}
            
            ä¸€ä¸ªç®€æ´ä¼˜é›…çš„æ¡Œé¢éŸ³ä¹æ’­æ”¾å™¨ï¼ŒåŸºäº Electron + SQLite æ„å»ºã€‚
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - ğŸµ **å¤šæ ¼å¼æ”¯æŒ**: MP3, WAV, OGG, FLAC, M4A, AAC ç­‰
            - ğŸ“Š **éŸ³é¢‘å¯è§†åŒ–**: é¢‘è°±ã€æ³¢å½¢ã€å¾„å‘ä¸‰ç§æ•ˆæœ
            - ğŸ”Š **éŸ³é‡æ§åˆ¶**: æ»‘åŠ¨æ¡è°ƒèŠ‚ + ä¸€é”®é™éŸ³
            - ğŸ” **ABå¾ªç¯**: è®¾ç½®A/Bç‚¹å¾ªç¯æ’­æ”¾æŒ‡å®šåŒºé—´
            - â±ï¸ **å€’è®¡æ—¶**: 10/20/30/45/60åˆ†é’Ÿè‡ªåŠ¨åœæ­¢
            - ğŸ“‚ **æ–‡ä»¶å¤¹ç®¡ç†**: æ”¯æŒå¤šæ–‡ä»¶å¤¹åˆ†ç±»ç®¡ç†
            - â¤ï¸ **æ”¶è—åŠŸèƒ½**: æ ‡è®°å–œæ¬¢çš„æ­Œæ›²
            - âŒ¨ï¸ **å¿«æ·é”®**: å®Œæ•´çš„é”®ç›˜å¿«æ·é”®æ”¯æŒ
            - ğŸ’¾ **çŠ¶æ€ä¿å­˜**: è‡ªåŠ¨è®°å¿†æ’­æ”¾ä½ç½®å’ŒéŸ³é‡
            - ğŸ® **å¤šæ¨¡å¼**: åˆ—è¡¨å¾ªç¯ã€å•æ›²å¾ªç¯ã€éšæœºã€å°é²œæ¨¡å¼
            
            ### ğŸ’¾ ä¸‹è½½è¯´æ˜
            
            **Windows:**
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.exe` - NSIS å®‰è£…åŒ…ï¼ˆæ¨èï¼‰
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-portable.exe` - ç»¿è‰²å…å®‰è£…ç‰ˆ
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.zip` - ZIP å‹ç¼©åŒ…
            
            **macOS:**
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.dmg` - Intel èŠ¯ç‰‡
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-arm64.dmg` - Apple Silicon (M1/M2/M3)
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.zip` - Intel èŠ¯ç‰‡ ZIP
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-arm64.zip` - Apple Silicon ZIP
            
            **Linux:**
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.AppImage` - é€šç”¨æ ¼å¼ï¼ˆæ¨èï¼‰
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.deb` - Debian/Ubuntu
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.rpm` - Fedora/RedHat
            - `Muse-Player-${{ steps.get_version.outputs.VERSION }}-x64.tar.gz` - é€šç”¨å‹ç¼©åŒ…
            
            ### âŒ¨ï¸ å¿«æ·é”®
            
            | å¿«æ·é”® | åŠŸèƒ½ |
            |--------|------|
            | `Space` | æ’­æ”¾/æš‚åœ |
            | `â†/â†’` | åé€€/å‰è¿› 15ç§’ |
            | `â†‘/â†“` | éŸ³é‡ +5% / -5% |
            | `P/N` | ä¸Šä¸€æ›²/ä¸‹ä¸€æ›² |
            | `A/B` | è®¾ç½® AB å¾ªç¯ç‚¹ |
            | `T` | æ‰“å¼€å€’è®¡æ—¶ |
            | `M` | é™éŸ³/å–æ¶ˆé™éŸ³ |
            | `Ctrl+O` | æ·»åŠ æ–‡ä»¶å¤¹ |
            | `Ctrl+I` | å¯¼å…¥éŸ³ä¹ |
            
            ---
            
            ğŸ› **é—®é¢˜åé¦ˆ**: [Issues](https://github.com/${{ github.repository }}/issues)
            ğŸ“ **è®¸å¯è¯**: MIT License
          files: |
            artifacts/windows/*
            artifacts/macos/*
            artifacts/linux/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
